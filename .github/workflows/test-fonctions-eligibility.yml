name: Test Functions                                                                                                                                               
                                                                                                                                                                    
on:                                                                                                                                                                
   push:                                                                                                                                                            
     branches: [ main ]                                                                                                                                             
   pull_request:                                                                                                                                                    
     branches: [ main ]                                                                                                                                             
   workflow_dispatch:                                                                                                                                               
                                                                                                                                                                    
jobs:                                                                                                                                                              
 test:                                                                                                                                                            
   runs-on: ubuntu-latest                                                                                                                                         
                                                                                                                                                                  
   env:                                                                                                                                                           
     SUPABASE_URL: ${{ secrets.SUPABASE_URL }}                                                                                                                    
     SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}                                                                                                          
     SUPABASE_DB_PASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}                                                                                                    
     SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}                                                                                                    
                                                                                                                                                                  
   steps:                                                                                                                                                         
     - uses: actions/checkout@v3                                                                                                                                  
                                                                                                                                                                  
     - name: Debug - List repository contents                                                                                                                     
       run: |                                                                                                                                                     
         pwd                                                                                                                                                      
         ls -la                                                                                                                                                   
         ls -la migrations/                                                                                                                                       
                                                                                                                                                                  
     - uses: denoland/setup-deno@v1                                                                                                                               
       with:                                                                                                                                                      
         deno-version: v1.x                                                                                                                                       
                                                                                                                                                                  
     - uses: supabase/setup-cli@v1                                                                                                                                
       with:                                                                                                                                                      
         version: latest                                                                                                                                          
                                                                                                                                                                  
     - name: Initialize Supabase project                                                                                                                          
       run: |                                                                                                                                                     
         supabase link --password ${{ secrets.SUPABASE_DB_PASSWORD }} --project-ref ${{ secrets.SUPABASE_PROJECT_REF }}                                           
                                                                                                                                                                  
     - name: Start Supabase and reset database                                                                                                                    
       run: |                                                                                                                                                     
         supabase start                                                                                                                                           
         supabase db reset                                                                                                                                        
                                                                                                                                                                  
     - name: Debug - List Supabase project structure                                                                                                              
       run: |                                                                                                                                                     
         supabase status                                                                                                                                          
         ls -la .temp/                                                                                                                                            
         ls -la supabase/ || echo "No supabase directory"                                                                                                         
                                                                                                                                                                  
     - name: Apply migrations                                                                                                                                     
       run: |                                                                                                                                                     
         supabase migration up                                                                                                                                    
                                                                                                                                                                  
     - name: Run eligibility tests                                                                                                                                
       run: |                                                                                                                                                     
         deno test --allow-env --allow-read --allow-net functions/tests/check_eligibility-test.ts                                                                 
                                                                                                                                                                  
     - name: Stop Supabase                                                                                                                                        
       if: always()                                                                                                                                               
       run: |                                                                                                                                                     
         supabase stop
